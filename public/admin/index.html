<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Content Manager</title>
    <style>
      #loader {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }
      .error-message {
        color: #e53e3e;
        padding: 20px;
        border: 1px solid #feb2b2;
        border-radius: 4px;
        background-color: #fff5f5;
        margin: 20px;
      }
    </style>
    <!-- Load Decap CMS with defer to ensure DOM is ready -->
    <script defer src="https://unpkg.com/decap-cms@3.4.0/dist/decap-cms.js"></script>
  </head>
  <body>
    <div id="loader">Loading Content Management System...</div>
    <div id="nc-root"></div>

    <script>
      // Show loader until CMS is initialized
      const loader = document.getElementById('loader');
      const root = document.getElementById('nc-root');

      function initCMS() {
        if (!window.CMS) {
          console.error('CMS not loaded yet, retrying in 100ms');
          setTimeout(initCMS, 100);
          return;
        }

        try {
          console.log('Initializing CMS...');
          window.CMS.init({
            config: {
              backend: {
                name: 'github',
                repo: 'RishiCo-Canna/RishiStaticNEXTsite',
                branch: 'main',
                auth_scope: 'repo',
                base_url: window.location.origin,
                auth_endpoint: '/api/auth'
              },
              local_backend: false,
              media_folder: 'public/images',
              public_folder: '/images',
              collections: [
                {
                  name: 'pages',
                  label: 'Pages',
                  folder: 'content/pages',
                  create: true,
                  fields: [
                    { label: 'Title', name: 'title', widget: 'string' },
                    { label: 'Body', name: 'body', widget: 'markdown' }
                  ]
                }
              ]
            }
          });

          // Hide loader once CMS is initialized
          if (loader) {
            loader.style.display = 'none';
          }
        } catch (error) {
          console.error('Failed to initialize CMS:', error);
          if (loader) {
            loader.innerHTML = `
              <div class="error-message">
                <h2>Failed to initialize CMS</h2>
                <p>${error.message}</p>
                <p>Please check the console for more details.</p>
              </div>
            `;
          }
        }
      }

      // Wait for DOM to be ready before initializing
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCMS);
      } else {
        initCMS();
      }
    </script>
  </body>
</html>